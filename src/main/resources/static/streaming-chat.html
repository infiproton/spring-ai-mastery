<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Streaming Text Chat</title>

    <link
            href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
            rel="stylesheet"
    >
</head>
<body class="bg-light">

<div class="container mt-4" style="max-width: 800px;">
    <h3 class="mb-3">Streaming Text Chat</h3>

    <div class="mb-3">
        <textarea
                id="message"
                class="form-control"
                rows="4"
                placeholder="Type your message here..."
        ></textarea>
    </div>

    <button id="sendBtn" class="btn btn-primary">
        Send (Streaming)
    </button>

    <hr/>

    <h5>AI Response (Streaming)</h5>
    <pre id="response"
         class="bg-white p-3 border rounded"
         style="min-height: 150px; white-space: pre-wrap;">
</pre>
</div>

<script>
    const sendBtn = document.getElementById("sendBtn");
    const messageInput = document.getElementById("message");
    const responseBox = document.getElementById("response");

    sendBtn.onclick = async () => {
        const message = messageInput.value.trim();
        if (!message) return;

        responseBox.textContent = "";
        sendBtn.disabled = true;

        try {
            const response = await fetch("/ai/chat/stream", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "Accept": "text/event-stream"
                },
                body: JSON.stringify({ message })
            });

            const reader = response.body.getReader();
            const decoder = new TextDecoder("utf-8");

            while (true) {
                const { value, done } = await reader.read();
                if (done) break;
                const chunk = decoder.decode(value);
                const lines = chunk.split("\n");

                lines.forEach(line => {
                    if (line.startsWith("data:")) {
                        const text = line.replace("data:", "");
                        if (text) {
                            responseBox.textContent += text + "";
                        }
                    }
                });
            }

        } catch (err) {
            responseBox.textContent =
                "Streaming failed: " + err.message;
        } finally {
            sendBtn.disabled = false;
        }
    };
</script>

</body>
</html>
