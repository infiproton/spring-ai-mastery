<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Unified Chat UI</title>

    <link
            href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
            rel="stylesheet"
    >
</head>
<body class="bg-light">

<div class="container mt-4" style="max-width: 900px;">
    <h3 class="mb-3">Unified Chat UI</h3>

    <div class="mb-3">
        <label class="form-label">Interaction Mode</label>
        <select id="mode" class="form-select">
            <option value="text">Text (Blocking)</option>
            <option value="stream">Text (Streaming)</option>
            <option value="audio">Audio (Voice)</option>
        </select>
    </div>

    <div class="mb-3">
        <textarea
                id="message"
                class="form-control"
                rows="4"
                placeholder="Type your message here..."
        ></textarea>
    </div>

    <div class="mb-3">
        <button id="sendBtn" class="btn btn-primary">Send</button>
        <button id="recordBtn" class="btn btn-danger ms-2 d-none">Record</button>
        <button id="stopBtn" class="btn btn-secondary ms-2 d-none">Stop</button>
    </div>

    <hr/>

    <h5>AI Response</h5>
    <pre id="response"
         class="bg-white p-3 border rounded"
         style="min-height: 150px; white-space: pre-wrap;"></pre>

    <audio id="audioPlayer" class="mt-3 d-none" controls></audio>
</div>

<script>
    const modeSelect = document.getElementById("mode");
    const messageInput = document.getElementById("message");
    const sendBtn = document.getElementById("sendBtn");
    const recordBtn = document.getElementById("recordBtn");
    const stopBtn = document.getElementById("stopBtn");
    const responseBox = document.getElementById("response");
    const audioPlayer = document.getElementById("audioPlayer");

    let mediaRecorder;
    let audioChunks = [];

    modeSelect.onchange = () => {
        const mode = modeSelect.value;

        responseBox.textContent = "";
        audioPlayer.classList.add("d-none");

        if (mode === "audio") {
            messageInput.disabled = true;
            sendBtn.classList.add("d-none");
            recordBtn.classList.remove("d-none");
            stopBtn.classList.remove("d-none");
        } else {
            messageInput.disabled = false;
            sendBtn.classList.remove("d-none");
            recordBtn.classList.add("d-none");
            stopBtn.classList.add("d-none");
        }
    };

    sendBtn.onclick = async () => {
        const message = messageInput.value.trim();
        if (!message) return;

        responseBox.textContent = "";

        if (modeSelect.value === "text") {
            const res = await fetch("/ai/chat", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ message })
            });
            responseBox.textContent = await res.text();
        }

        if (modeSelect.value === "stream") {
            const res = await fetch("/ai/chat/stream", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "Accept": "text/event-stream"
                },
                body: JSON.stringify({ message })
            });

            const reader = res.body.getReader();
            const decoder = new TextDecoder();

            while (true) {
                const { value, done } = await reader.read();
                if (done) break;

                const chunk = decoder.decode(value);
                chunk.split("\n").forEach(line => {
                    if (line.startsWith("data:")) {
                        const text = line.replace("data:", "").trim();
                        if (text) {
                            responseBox.textContent += text + " ";
                        }
                    }
                });
            }
        }
    };

    recordBtn.onclick = async () => {
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        mediaRecorder = new MediaRecorder(stream);
        audioChunks = [];

        mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
        mediaRecorder.onstop = sendAudio;

        mediaRecorder.start();
    };

    stopBtn.onclick = () => {
        mediaRecorder.stop();
    };

    async function sendAudio() {
        const audioBlob = new Blob(audioChunks, { type: "audio/webm" });
        const formData = new FormData();
        formData.append("file", audioBlob, "recording.webm");

        const res = await fetch("/ai/chat/audio/voice", {
            method: "POST",
            body: formData
        });

        responseBox.textContent =
            res.headers.get("X-AI-Response") || "";

        const audio = await res.blob();
        audioPlayer.src = URL.createObjectURL(audio);
        audioPlayer.classList.remove("d-none");
    }
</script>

</body>
</html>
